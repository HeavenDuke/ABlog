"use strict";!function(){var a=function(a){confirm("删除后将无法恢复，确认要删除吗？")&&(window.location.href=a)},t={},e=function(){var a=$(this).attr("diary_id"),t=$("#"+a+"_brief").text().trim(),e=$("#"+a+"_content").attr("content"),r=$("#"+a+"_date").attr("date"),n=$("#"+a+"_mood").attr("mood"),l=$("#"+a+"_tag").attr("tag"),o="true"==$("#"+a+"_publicity").attr("publicity"),c=$("#"+a+"_images"),d=JSON.parse(c.attr("images")),u=c.children();$("#update_diary_brief").val(t),$("#update_diary_content").val(e),$("#update_diary_date").attr("value",r),$("#update_diary_mood").val(n),$("#update_diary_tag").val(l);var s=$("#image_update_specifier");s.val(JSON.stringify(d)),o?$("#update_diary_publicity").attr("checked","checked"):$("#update_diary_publicity").removeAttr("checked"),$("#update_uploaded_files").empty();for(var f=0;f<d.length;f++){var p=$('<a filename="'+d[f]+'" href="#"><img class="margin image_thumb" src="'+$(u[f]).attr("thumb")+'"/></a>');p.appendTo("#update_uploaded_files"),p.on("click",function(){i($(this),s)})}$("#update_diary_form").attr("action","/diaries/"+a+"?_method=put")},r=function(){$("a[data-target='#edit_diary_modal']").on("click",e)},i=function(a,t){if(confirm("确认要删除该照片吗？")){for(var e=a.attr("filename"),r=JSON.parse(t.val()),i=0;i<r.length;i++)if(r[i]==e){r.splice(i,1);break}t.val(JSON.stringify(r)),a.remove()}},n=function(){for(var a=$("[id$='_gallery']"),t=0;t<a.length;t++)$(a[t]).lightGallery({thumbnail:!0})},l=function(){$("#image_creation_uploader").fileupload({url:"/images",dataType:"json",type:"post",done:function(a,t){$.each(t.result.files,function(a,t){var e=$("#image_creation_specifier"),r=JSON.parse(e.val());r.push(t.name),e.val(JSON.stringify(r));var n=$('<a filename = "'+t.name+'" href="#"><img class="margin image_thumb" src="'+t.thumbnailUrl+'"/></a>');n.appendTo("#create_uploaded_files"),n.on("click",function(){i($(this),e)})})},progressall:function(a,t){var e=parseInt(t.loaded/t.total*100,10);$("#create_upload_progress .progress-bar").css("width",e+"%")}}),$("#image_update_uploader").fileupload({url:"/images",dataType:"json",type:"post",done:function(a,t){$.each(t.result.files,function(a,t){var e=$("#image_update_specifier"),r=JSON.parse(e.val());r.push(t.name),e.val(JSON.stringify(r));var n=$('<a filename = "'+t.name+'" href="#"><img class="margin image_thumb" src="'+t.thumbnailUrl+'"/></a>');n.appendTo("#update_uploaded_files"),n.on("click",function(){i($(this),e)})})},progressall:function(a,t){var e=parseInt(t.loaded/t.total*100,10);$("#update_upload_progress .progress-bar").css("width",e+"%")}})},o=function(){for(var a=$("[id$='_content']"),e=0;e<a.length;e++){var r=$(a[e]).attr("id"),i=$(a[e]).text();$(a[e]).html(function(a){var t=a.split("\n"),e="";for(var r in t)e+="<p>"+t[r]+"</p>";return e}(i)),t[r.substring(0,r.indexOf("_content"))]=i}},c=function(){for(var a=$("img"),t=0;t<a.length;t++){var e=$(a[t]);e.attr("src",e.attr("thumb_url"))}},d=function(){$(".jscroll").jscroll({autoTrigger:!1,nextSelector:"#scroller",callback:function(){var t=$(".jscroll-added"),r=$("#pscroller"),i=t.children("li");if(i.find("a[data-target='#edit_diary_modal']").on("click",e),i.find(".delete-entry").on("click",function(){return a($(this).attr("href")),!1}),r.before(i),0==t.children("#scroller").length){var n=t.children("#end_marker");r.after(n),r.remove(),t.remove()}}})},u=function(){r(),o(),c(),d(),n(),l()};$(document).on("ready",function(){null!=window.location.href.match(/\/diaries/)&&u()})}();