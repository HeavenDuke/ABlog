!function(){var a=function(a){confirm("删除后将无法恢复，确认要删除吗？")&&(window.location.href=a)},e={},t=function(){var a=$(this).attr("diary_id"),e=$("#"+a+"_brief").text().trim(),t=$("#"+a+"_content").attr("content"),r=$("#"+a+"_date").attr("date"),n=$("#"+a+"_mood").attr("mood"),l=$("#"+a+"_tag").attr("tag"),o="true"==$("#"+a+"_publicity").attr("publicity"),d=$("#"+a+"_images"),c=JSON.parse(d.attr("images")),u=d.children();$("#update_diary_brief").val(e),$("#update_diary_content").val(t),$("#update_diary_date").attr("value",r),$("#update_diary_mood").val(n),$("#update_diary_tag").val(l);var s=$("#image_update_specifier");s.val(JSON.stringify(c)),o?$("#update_diary_publicity").attr("checked","checked"):$("#update_diary_publicity").removeAttr("checked"),$("#update_uploaded_files").empty();for(var f=0;f<c.length;f++){var p=$('<a filename="'+c[f]+'" href="#"><img class="margin image_thumb" src="'+$(u[f]).attr("thumb")+'"/></a>');p.appendTo("#update_uploaded_files"),p.on("click",function(){i($(this),s)})}$("#update_diary_form").attr("action","/diaries/"+a+"?_method=put")},r=function(){$("a[data-target='#edit_diary_modal']").on("click",t)},i=function(a,e){if(confirm("确认要删除该照片吗？")){for(var t=a.attr("filename"),r=JSON.parse(e.val()),i=0;i<r.length;i++)if(r[i]==t){r.splice(i,1);break}e.val(JSON.stringify(r)),a.remove()}},n=function(){for(var a=$("[id$='_gallery']"),e=0;e<a.length;e++)$(a[e]).lightGallery({thumbnail:!0})},l=function(){$("#image_creation_uploader").fileupload({url:"/images",dataType:"json",type:"post",done:function(a,e){$.each(e.result.files,function(a,e){var t=$("#image_creation_specifier"),r=JSON.parse(t.val());r.push(e.name),t.val(JSON.stringify(r));var n=$('<a filename = "'+e.name+'" href="#"><img class="margin image_thumb" src="'+e.thumbnailUrl+'"/></a>');n.appendTo("#create_uploaded_files"),n.on("click",function(){i($(this),t)})})},progressall:function(a,e){var t=parseInt(e.loaded/e.total*100,10);$("#create_upload_progress .progress-bar").css("width",t+"%")}}),$("#image_update_uploader").fileupload({url:"/images",dataType:"json",type:"post",done:function(a,e){$.each(e.result.files,function(a,e){var t=$("#image_update_specifier"),r=JSON.parse(t.val());r.push(e.name),t.val(JSON.stringify(r));var n=$('<a filename = "'+e.name+'" href="#"><img class="margin image_thumb" src="'+e.thumbnailUrl+'"/></a>');n.appendTo("#update_uploaded_files"),n.on("click",function(){i($(this),t)})})},progressall:function(a,e){var t=parseInt(e.loaded/e.total*100,10);$("#update_upload_progress .progress-bar").css("width",t+"%")}})},o=function(){for(var a=$("[id$='_content']"),t=0;t<a.length;t++){var r=$(a[t]).attr("id"),i=$(a[t]).text();$(a[t]).html(function(a){var e=a.split("\n"),t="";for(var r in e)t+="<p>"+e[r]+"</p>";return t}(i)),e[r.substring(0,r.indexOf("_content"))]=i}},d=function(){for(var a=$("img"),e=0;e<a.length;e++){var t=$(a[e]);t.attr("src",t.attr("thumb_url"))}},c=function(){$(".jscroll").jscroll({autoTrigger:!1,nextSelector:"#scroller",callback:function(){var e=$(".jscroll-added"),r=$("#pscroller"),i=e.children("li");if(i.find("a[data-target='#edit_diary_modal']").on("click",t),i.find(".delete-entry").on("click",function(){return a($(this).attr("href")),!1}),r.before(i),0==e.children("#scroller").length){var n=e.children("#end_marker");r.after(n)}r.remove(),e.remove()}})},u=function(){r(),o(),d(),c(),n(),l()};$(document).on("ready",function(){null!=window.location.href.match(/\/diaries/)&&u()})}();